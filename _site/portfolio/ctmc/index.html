<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.18.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>  Phylogenetic Comparative Methods at UH</title>
<meta name="description" content="">


  <meta name="author" content="Rosana Zenil-Ferguson">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Phylogenetic Comparative Methods at UH">
<meta property="og:title" content="">
<meta property="og:url" content="roszenil.github.io/portfolio/ctmc/">




  <meta property="og:image" content="roszenil.github.io/assets/images/ctmc_files/bichromqmat.png">





  <meta property="article:published_time" content="2019-06-05T00:00:00-10:00">






<link rel="canonical" href="roszenil.github.io/portfolio/ctmc/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Rosana Zenil-Ferguson",
      "url": "roszenil.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Phylogenetic Comparative Methods at UH Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Phylogenetic Comparative Methods at UH
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/people/" >People</a>
            </li><li class="masthead__menu-item">
              <a href="/research/" >Research</a>
            </li><li class="masthead__menu-item">
              <a href="/portfolio/" >Teaching</a>
            </li><li class="masthead__menu-item">
              <a href="/contact/" >Contact</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style=" background-image: url('/assets/images/ctmc_files/bichromqmat.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          

        
      </h1>
      
        <p class="page__lead">
</p>
      
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/ls2.jpg" alt="Rosana Zenil-Ferguson" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Rosana Zenil-Ferguson</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Assistant Professor. University of Hawai’i</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://roszenil.github.io" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> roszenil.github.io</a></li>
          
        
          
            <li><a href="https://twitter.com/roszenil" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> roszenil</a></li>
          
        
          
            <li><a href="https://github.com/roszenil" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> roszenil</a></li>
          
        
      

      

      
        <li>
          <a href="mailto:roszenil@hawaii.edu">
            <meta itemprop="email" content="roszenil@hawaii.edu" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Workshops</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/portfolio/SDD/" class="">SSE models</a></li>
          
            
            

            
            

            <li><a href="/portfolio/SSBworkshop/" class="">SSE in RevBayes. SSB workshop 2020</a></li>
          
            
            

            
            

            <li><a href="/portfolio/ctmc/" class="active">Continuous- Time Markov Chains</a></li>
          
            
            

            
            

            <li><a href="/portfolio/evidence/" class="">Evidential Stats</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2019-06-05T00:00:00-10:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#continuous-time-markov-chains-ctmc">Continuous-Time Markov Chains (CTMC)</a>
    <ul>
      <li><a href="#what-is-a-q-matrix">What is a Q-matrix?</a>
        <ul>
          <li><a href="#flower-color-evolution-example">Flower color evolution example</a></li>
        </ul>
      </li>
      <li><a href="#calculating-the-likelihood-of-a-ctmc-for-discrete-traits">Calculating the likelihood of a CTMC for discrete traits</a>
        <ul>
          <li><a href="#probabilities-at-the-root">Probabilities at the root</a></li>
          <li><a href="#real-examples">Real examples</a></li>
          <li><a href="#references">References</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="continuous-time-markov-chains-ctmc">Continuous-Time Markov Chains (CTMC)</h1>

<p>Continuous-time Markov chains (CTMC) are stochastic processes that allow us to follow the evolution of a trait(s) of interest. For example,
one might be interested in how flower color has evolved in a clade (blue to red) or how quickly a species  moved from region A to B.</p>

<p>CTMCs are usually denoted in mathematical notation as <script type="math/tex">\{X(t), t\geq 0 \}</script>; the stochastic process <script type="math/tex">X(t)</script> follows flower color throughout time <script type="math/tex">t</script>. Time is continuous and it is measured using branch lengths. For discrete traits the process <script type="math/tex">X(t)</script> takes values  in the natural numbers <script type="math/tex">0,1,2,...</script>.  CTMCs have many (cool) mathematical properties, but one of the most important  property is the Markovian property that states that  the probability distribution of future states of the process conditional on both past and present states) depends only upon the present state.</p>

<p>Mathematically, CTMC can be defined via stochastic equations (which will be super important when you are studying diversification methods) or via an infinitesimal probability matrix, better known as the Q-matrix.</p>

<h2 id="what-is-a-q-matrix">What is a Q-matrix?</h2>
<p>In mathematics, the Q-matrix is the derivative of the probability matrix (<script type="math/tex">P'(t)=P(t)Q</script>). The  elements off the diagonal of the <script type="math/tex">Q</script> matrix are transition rates and in the diagonal we have the negative sum of all the elemets of the row. The row adds to zero this is because probability matrices rows add to 1 so the derivative of the constant 1 is zero.</p>

<h3 id="flower-color-evolution-example">Flower color evolution example</h3>
<p>We are interested in following the evolution of flower color in a clade with only three taxa.  We propose a CTMC model to follow along how color has evolve in a clade of interest. We define our Q-matrix as follows</p>

<p><img src="/assets/images/ctmc_files/qmatrix.png" alt="" /></p>

<p>From blue to red evolution can happen with a rate <script type="math/tex">\alpha</script> and from red to blue evolution happens with a rate <script type="math/tex">\beta</script> What does this even mean? How do I interpret these rates?</p>

<p><img src="/assets/images/ctmc_files/sojourntimes.png" alt="" /></p>

<p>To evolve from blue to red a lineage is expected to wait <script type="math/tex">1/ \alpha</script> units of time so if <script type="math/tex">\alpha</script> is large that means that the expected waiting time to evolve is fast. Time units come handy here, if they are millions of years we can start thinking about the average number of changes we expect to see in the tree and translate this into rates of the Q-matrix (useful for prior distribution elicitation).</p>

<p>** Based on these rates what is the probability that  a plant evolves from blue to red?**</p>

<p>The rates in the Q-matrix is the derivative of the probability, so in general <script type="math/tex">P(t)=e^{Qt}</script> (think about the exponential of a matrix for a second).</p>

<p>The general solution for the probabilities of the Q-matrix we proposed are
<img src="/assets/images/ctmc_files/pmatrix.png" alt="" /></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prob.mat</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">t</span><span class="p">){</span><span class="w">
</span><span class="n">exp.val</span><span class="o">&lt;-</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w">
</span><span class="n">probabilities</span><span class="o">&lt;</span><span class="m">-1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">beta</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">exp.val</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="n">exp.val</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">exp.val</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="o">*</span><span class="n">exp.val</span><span class="p">),</span><span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="nf">return</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">(</span><span class="n">P.mat</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prob.mat</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="m">1</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>It looks ugly but what the matrix is saying is that in a time <script type="math/tex">t</script> a flower will evolve from blue to red with probability <script type="math/tex">P(X(t)=Red\|X(0)=Blue)=\frac{1}{\alpha+\beta}(\beta-\alpha e^{-(\alpha+\beta)t})</script>.</p>

<p>Q-matrices can get really crazy!  Chromosome number matrices for example
<img src="/assets/images/ctmc_files/bichromqmat.png" alt="" /></p>

<p>So calculating the probabilities from algebra for large matrices is impossible so we use numerical approximations</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#install.package("expm")</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"expm"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="n">Q.mat</span><span class="o">&lt;-</span><span class="n">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-0.2</span><span class="p">,</span><span class="m">0.3</span><span class="p">,</span><span class="m">0.2</span><span class="p">,</span><span class="m">-0.3</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="n">P.mat</span><span class="o">&lt;-</span><span class="n">expm</span><span class="p">(</span><span class="n">Q.mat</span><span class="o">*</span><span class="m">1</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<h2 id="calculating-the-likelihood-of-a-ctmc-for-discrete-traits">Calculating the likelihood of a CTMC for discrete traits</h2>

<p>We will be calculating the likelihood using the probability matrix above in this three-tip tree. The likelihood is not a straightforward calculation because our sample is not independent, the shared ancestry needs to be considered.</p>

<p><img src="/assets/images/ctmc_files/phylo1.png" alt="" /></p>

<p>We are going to assume that our parameters are <script type="math/tex">\alpha=0.2</script> and <script type="math/tex">\beta=0.3</script>. Calculating the likelihood of a non-independent sample is numerical intensive and you will get taste of this.</p>

<p>Let’s start with the smallest clade</p>

<p><img src="/assets/images/ctmc_files/phylo2.png" alt="" /></p>

<p>The internal node can be either Red or Blue but we really don’t know.</p>

<p>Let’s assume it is blue</p>

<p><img src="/assets/images/ctmc_files/pruning1.png" alt="" /></p>

<p>The probablity of evolving from blue to blue is the (1,1) entry of the probablity matrix P(t). In mathematical terms <script type="math/tex">P(X(t_2)=Blue \|X(t_1)=Blue)=P_{Blue \to Blue}(1)</script>. This happens not only for one lineage but for both descendants of
the node so in reality we have to multiply that probability twice. So we can build a little table of both cases.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">If internal node is  <script type="math/tex">X(t_1)=Blue</script></th>
      <th style="text-align: center">If internal node is <script type="math/tex">X(t_ 1)=Red</script></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><script type="math/tex">[P(X(t_2)=Blue |X(t_1)=Blue)]^2</script></td>
      <td style="text-align: center"><script type="math/tex">[P(X(t_2)=Blue |X(t_1)=Red)]^2</script></td>
    </tr>
    <tr>
      <td style="text-align: center"><script type="math/tex">[P_{Blue \to Blue}(1)]^2=[e^{Q}]_{11}</script></td>
      <td style="text-align: center"><script type="math/tex">[P_{Red \to Blue}(1)]^2=[e^Q]_{21}</script></td>
    </tr>
  </tbody>
</table>

<p>The probabilities above are called conditional likelihoods (we are conditioning at each possible value of the internal node)  and we are going to store them for later use. Let’s continue to assume that at the node the trait is blue, that is <script type="math/tex">X(t_1)=Blue</script>.
What is the probability that it actually happened to be blue?</p>

<p>Think about the possible pathways</p>

<p><img src="/assets/images/ctmc_files/pruning1.png" alt="" /></p>

<ul>
  <li>Internal node is  <script type="math/tex">X(t_1)=Blue</script>  and root is  <script type="math/tex">X(t_0)=Blue</script></li>
  <li>Internal node is  <script type="math/tex">X(t_1)=Blue</script>  and root is  <script type="math/tex">X(t_0)=Red</script></li>
</ul>

<h3 id="probabilities-at-the-root">Probabilities at the root</h3>
<p>Finally, we need to think about the probability of the root being  Blue or Red</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Blue</th>
      <th style="text-align: center">Red</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><script type="math/tex">\pi(Blue)</script></td>
      <td style="text-align: center"><script type="math/tex">\pi(Red)</script></td>
    </tr>
  </tbody>
</table>

<p>So what are these probabilities? What would you write?</p>

<p>Interestingly, this is still an open question for discrete character evolution. In general people have done</p>
<ul>
  <li>Uniform probabilities <script type="math/tex">\pi(Blue)=\pi(Red)=1/2</script></li>
  <li>Weighted averages of likelihood. For example we fix our root to be Blue, calculate likelihood <script type="math/tex">L_{Blueroot}</script>, then we fix it to be Red calculate <script type="math/tex">L_{Redroot}</script> and then the root is given probabilities <script type="math/tex">(\pi(Blue),\pi(Red))=\Large(\frac{L_{Blueroot}}{L_{Blueroot}+L_{Redroot}},\frac{L_{Redroot}}{L_{Blueroot}+L_{Redroot}}\Large)</script></li>
  <li>Stationary distribution</li>
  <li>My new favorite the root probabilities are unknown and random varialbles and getting the posterior probabilities of the vector <script type="math/tex">(\pi(Blue),\pi(Red))</script></li>
</ul>

<p>Finally, the likelihood is the result of considering the probabilities all across the possible histories in the nodes of the tree.</p>

<p><img src="/assets/images/ctmc_files/phylo3.png" alt="" /></p>

<h3 id="real-examples">Real examples</h3>
<ol>
  <li>Ng, J. and Smith, S.D., 2016. Widespread flower color convergence in Solanaceae via alternate biochemical pathways. New Phytologist, 209(1), pp.407-417.</li>
</ol>

<p>Figure 1. of Ng and Smith (2016)</p>

<p><img src="/assets/images/ctmc_files/NgSmith.png" alt="" /></p>

<ol>
  <li>Implementation in RevBayes for selfing and non-selfing taxa in Polimoneaceae
    <ul>
      <li><a href="https://github.com/phylosdd/MidwestPhylo2019/tree/master/docs/class/Discretetraitrevbayes/data">Data</a></li>
      <li><a href="https://github.com/phylosdd/MidwestPhylo2019/blob/master/docs/class/Discretetraitrevbayes/mk2.Rev">RevCode</a></li>
    </ul>
  </li>
</ol>

<p><img src="/assets/images/ctmc_files/posteriorflower.png" alt="" /></p>

<ol>
  <li>Chromploid package- Large Q-matrices
<img src="/assets/images/ctmc_files/polyploidyprofilerho.png" alt="" /></li>
</ol>

<h3 id="references">References</h3>
<ul>
  <li>Felsenstein, J., 1981. Evolutionary trees from DNA sequences: a maximum likelihood approach. Journal of molecular evolution, 17(6), pp.368-376.</li>
  <li>Ng, J. and Smith, S.D., 2016. Widespread flower color convergence in Solanaceae via alternate biochemical pathways. New Phytologist, 209(1), pp.407-417.</li>
  <li>Zenil‐Ferguson, R., Burleigh, J.G. and Ponciano, J.M., 2018. chromploid: An R package for chromosome number evolution across the plant tree of life. Applications in plant sciences, 6(3), p.e1037.
<a href="https://github.com/roszenil/chromploid">chromploid R package</a></li>
  <li>Blackmon, H., Justison, J., Mayrose, I. and Goldberg, E.E., 2019. Meiotic drive shapes rates of karyotype evolution in mammals. Evolution, 73(3), pp.511-523.
<a href="https://github.com/coleoguy/chromePlus">chromePlus R package</a></li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-06-05T00:00:00-10:00">June 5, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/portfolio/evidence/" class="pagination--pager" title="
">Previous</a>
    
    
      <a href="/portfolio/SDD/" class="pagination--pager" title="
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/roszenil" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> roszenil</a></li>
        
      
        
          <li><a href="https://github.com/roszenil" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Rosana Zenil-Ferguson. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
<script src="/assets/js/main.min.js"></script>
<script src="https://kit.fontawesome.com/4eee35f757.js"></script>










<script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>



  </body>
</html>
